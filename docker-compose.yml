# Version line removed to avoid the "obsolete" warning
services:
  # --- CORE: GRAVITAS MCP (THE TARGET) ---
  gravitas_mcp:
    container_name: gravitas_mcp
    build:
      context: .
      dockerfile: Dockerfile
    # CRITICAL FIX: "sleep infinity" keeps the container running 24/7.
    # Cline will inject the python process manually using 'docker exec'.
    command: [ "sleep", "infinity" ]
    volumes:
      - .:/app
    environment:
      - PYTHONPATH=/app
      - POSTGRES_HOST=Gravitas_postgres
      - QDRANT_HOST=Gravitas_qdrant
      - L1_URL=http://gravitas_supervisor:8000
      - L1_EMBED_URL=http://Gravitas_ollama_embed:11434
      - MINIO_HOST=Gravitas_minio
      # Ensure these match your .env
      - POSTGRES_USER=${DB_USER:-Gravitas_user}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-Gravitas_pass}
      - POSTGRES_DB=${DB_NAME:-chat_history}
    ports:
      - "8001:8000" # Maps port 8000 inside to 8001 outside (just in case)
    networks:
      - Gravitas_net
    restart: unless-stopped

  # --- GPU 0: GENERATION (TITAN RTX) ---
  ollama:
    image: ollama/ollama:latest
    container_name: Gravitas_ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ '0' ] # Titan RTX
              capabilities: [ gpu ]
    volumes:
      - ./data/ollama_models:/root/.ollama
    ports:
      - "11434:11434"
    environment:
      - OLLAMA_HOST=0.0.0.0
    networks:
      - Gravitas_net
    restart: always

  # --- GPU 1: EMBEDDINGS (GTX 1060) ---
  ollama_embed:
    image: ollama/ollama:latest
    container_name: Gravitas_ollama_embed
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ '1' ] # GTX 1060
              capabilities: [ gpu ]
    volumes:
      - ./data/ollama_embed_models:/root/.ollama
    ports:
      - "11435:11434" # Mapped to 11435 to avoid conflict with GPU 0
    environment:
      - OLLAMA_HOST=0.0.0.0
    networks:
      - Gravitas_net
    restart: always

  # --- MEMORY: QDRANT (HYBRID VECTOR DB) ---
  qdrant:
    image: qdrant/qdrant:latest
    container_name: Gravitas_qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./data/qdrant:/qdrant/storage
    environment:
      - QDRANT_ALLOW_RECOVERY_MODE=true
    networks:
      - Gravitas_net
    restart: always

  # --- STORAGE: MINIO (OBJECT STORE) ---
  minio:
    image: minio/minio:latest
    container_name: Gravitas_minio
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./data/minio:/data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    networks:
      - Gravitas_net
    restart: always

  # --- DATABASE: POSTGRES (HISTORY) ---
  Gravitas_postgres:
    image: postgres:16-alpine
    container_name: Gravitas_postgres
    environment:
      - POSTGRES_USER=${DB_USER:-Gravitas_user}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-Gravitas_pass}
      - POSTGRES_DB=${DB_NAME:-chat_history}
    volumes:
      - ./data/postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - Gravitas_net
    restart: always

  # --- API: GRAVITAS LOBBY (PUBLIC ENTRY POINT) ---
  gravitas_lobby:
    build: .
    container_name: Gravitas_lobby_v2
    # Optional: If you run the main app via uvicorn
    command: uvicorn app.main:app --host 0.0.0.0 --port 5050 --reload
    volumes:
      - .:/app
    ports:
      - "5050:5050"
    environment:
      - DATABASE_URL=postgresql://${DB_USER:-Gravitas_user}:${DB_PASSWORD:-Gravitas_pass}@Gravitas_postgres:5432/${DB_NAME:-chat_history}
      - DB_HOST=Gravitas_postgres
      - L1_URL=http://gravitas_supervisor:8000
      - L1_EMBED_URL=http://Gravitas_ollama_embed:11434
    networks:
      - Gravitas_net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]

  gravitas_gatekeeper:
    build:
      context: .
      dockerfile: Dockerfile.gatekeeper
    container_name: gravitas_gatekeeper
    ports:
      - "8002:8001"
    environment:
      - DATABASE_URL=postgresql://Gravitas_user:Gravitas_pass@Gravitas_postgres:5432/chat_history
      - DB_HOST=Gravitas_postgres
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-jwt-secret-key-change-me}
      - ACCESS_POLICY_PATH=app/config/access_policies.yaml
    depends_on:
      - Gravitas_postgres
    networks:
      - Gravitas_net

  gravitas_guardian:
    build:
      context: .
      dockerfile: Dockerfile.guardian
    container_name: gravitas_guardian
    command: uvicorn app.services.guardian.main:app --host 0.0.0.0 --port 8003
    ports:
      - "8003:8003"
    volumes:
      - ./app/.certificates:/app/app/.certificates:ro # Read-only certificate mount
    environment:
      - CERTIFICATES_DIR=/app/app/.certificates
    networks:
      - Gravitas_net
    restart: unless-stopped

  gravitas_router:
    build:
      context: .
      dockerfile: Dockerfile.router
    container_name: gravitas_router
    ports:
      - "8005:8004"
    environment:
      - OLLAMA_URL=http://Gravitas_ollama:11434/v1/chat/completions
      - GATEKEEPER_URL=http://gravitas_gatekeeper:8001
      - GUARDIAN_URL=http://gravitas_guardian:8003
      - AUTH_DISABLED=true
      # Add provider keys if needed, e.g. GEMINI_API_KEY from .env
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - DEEPINFRA_API_KEY=${DEEPINFRA_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      - gravitas_gatekeeper
      - gravitas_guardian
    networks:
      - Gravitas_net
    restart: unless-stopped

  gravitas_supervisor:
    build: .
    container_name: gravitas_supervisor
    command: uvicorn app.services.supervisor.main:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    environment:
      - OLLAMA_URL=http://Gravitas_ollama:11434/v1/chat/completions
      - GUARDIAN_URL=http://gravitas_guardian:8003
      - GATEKEEPER_URL=http://gravitas_gatekeeper:8001
    depends_on:
      - gravitas_guardian
    networks:
      - Gravitas_net
    restart: unless-stopped

networks:
  Gravitas_net:
    driver: bridge
